# vhost HTTP (redirection vers HTTPS)
<VirtualHost *:80>
    ServerName ndf.civicpower.org

    # En-têtes CORS
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, x-api-key, Authorization"
    Header always set Access-Control-Max-Age "3600"

    # Gestion des requêtes OPTIONS
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ - [R=204,L]
    </IfModule>

    # Redirection vers HTTPS en tenant compte de Cloudflare
    <IfModule mod_rewrite.c>
        RewriteCond %{REQUEST_METHOD} !OPTIONS
        # Vérifier si Cloudflare indique que c'est déjà HTTPS
        RewriteCond %{HTTP:X-Forwarded-Proto} !https
        RewriteCond %{HTTP:CF-Visitor} !https
        RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [R=301,L]
    </IfModule>

    ErrorLog /opt/bitnami/apache2/logs/ndf.civicpower.org-error.log
    CustomLog /opt/bitnami/apache2/logs/ndf.civicpower.org-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName ndf.civicpower.org

    # Configuration SSL
    SSLEngine on
    SSLCertificateFile "/etc/letsencrypt/live/ndf.civicpower.org/fullchain.pem"
    SSLCertificateKeyFile "/etc/letsencrypt/live/ndf.civicpower.org/privkey.pem"

    # Proxy vers l'API+frontend (service Docker sur 8080)
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/
    ProxyTimeout 300

    # Configuration CORS
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, x-api-key, Authorization"
    Header always set Access-Control-Max-Age "3600"

    # Restreindre /api/stats à localhost uniquement
    <Location "/api/stats">
        Require local
    </Location>
    <Location "/api/stats/">
        Require local
    </Location>

    ErrorLog /opt/bitnami/apache2/logs/ndf.civicpower.org-error.log
    CustomLog /opt/bitnami/apache2/logs/ndf.civicpower.org-access.log combined
</VirtualHost>